# é¡µé¢è·³è½¬éªŒè¯æ¸…å•

## ğŸ” SQLè¯­æ³•é”™è¯¯ä¿®å¤

**é—®é¢˜**ï¼šä½¿ç”¨ `as` ä½œä¸º SQL è¡¨åˆ«åå¯¼è‡´è¯­æ³•é”™è¯¯
```
SQLITE_ERROR: near "as": syntax error
```

**åŸå› **ï¼š`AS` æ˜¯ SQL ä¿ç•™å…³é”®å­—ï¼Œä¸èƒ½ç”¨ä½œè¡¨åˆ«å

**ä¿®å¤**ï¼šæ‰€æœ‰ SQL æŸ¥è¯¢ä¸­çš„ `as` è¡¨åˆ«åæ”¹ä¸º `arr_s`ï¼ˆarrival_stationsï¼‰
- âœ… `getOrderPaymentInfo` - ä¿®å¤å®Œæˆ
- âœ… `getOrderSuccessInfo` - ä¿®å¤å®Œæˆ  
- âœ… `getUserOrders` - ä¿®å¤å®Œæˆ

---

## ğŸ“‹ ä¸»è¦é¡µé¢è·³è½¬è·¯å¾„

### 1ï¸âƒ£ é¦–é¡µ â†’ è½¦æ¬¡åˆ—è¡¨é¡µ
**è§¦å‘**ï¼šç”¨æˆ·å¡«å†™æœç´¢è¡¨å•å¹¶ç‚¹å‡»"æŸ¥è¯¢"
**è·¯å¾„**ï¼š`/` â†’ `/trains`
**çŠ¶æ€ä¼ é€’**ï¼š`location.state = { fromCity, toCity, departureDate, isStudent, isHighSpeed }`
**æ–‡ä»¶**ï¼š`frontend/src/components/TrainSearchForm/TrainSearchForm.tsx`

### 2ï¸âƒ£ è½¦æ¬¡åˆ—è¡¨é¡µ â†’ è®¢å•å¡«å†™é¡µ
**è§¦å‘**ï¼šç”¨æˆ·ç‚¹å‡»è½¦æ¬¡çš„"é¢„å®š"æŒ‰é’®
**è·¯å¾„**ï¼š`/trains` â†’ `/order`
**çŠ¶æ€ä¼ é€’**ï¼š`location.state = { trainData: { trainNo, date, stations, prices } }`
**æ–‡ä»¶**ï¼š`frontend/src/components/TrainList/TrainList.tsx`

### 3ï¸âƒ£ è®¢å•å¡«å†™é¡µ â†’ æ”¯ä»˜é¡µé¢
**è§¦å‘**ï¼šç”¨æˆ·åœ¨è®¢å•ç¡®è®¤å¼¹çª—ç‚¹å‡»"ç¡®è®¤æ— è¯¯ï¼Œæäº¤è®¢å•"
**è·¯å¾„**ï¼š`/order` â†’ `/payment/:orderId`
**çŠ¶æ€ä¼ é€’**ï¼šURL å‚æ•° `orderId`
**æ–‡ä»¶**ï¼š
- `frontend/src/components/OrderFill/OrderConfirmModal.tsx` (æäº¤è®¢å•)
- `frontend/src/pages/OrderFillPage.tsx` (å¤„ç†è·³è½¬)

**å…³é”®ä»£ç **ï¼š
```typescript
// OrderConfirmModal.tsx
const response = await fetch('/api/orders/submit', { ... });
const data = await response.json();
if (data.success) {
  onConfirm(data.orderId); // ä¼ é€’ orderId ç»™çˆ¶ç»„ä»¶
}

// OrderFillPage.tsx
const handleConfirmOrder = (orderId: string) => {
  navigate(`/payment/${orderId}`);
};
```

### 4ï¸âƒ£ æ”¯ä»˜é¡µé¢ â†’ è´­ç¥¨æˆåŠŸé¡µ
**è§¦å‘**ï¼šç”¨æˆ·ç‚¹å‡»"ç½‘ä¸Šæ”¯ä»˜"æŒ‰é’®
**è·¯å¾„**ï¼š`/payment/:orderId` â†’ `/success/:orderId`
**çŠ¶æ€ä¼ é€’**ï¼šURL å‚æ•° `orderId`
**æ–‡ä»¶**ï¼š`frontend/src/pages/PaymentPage.tsx`

**å…³é”®ä»£ç **ï¼š
```typescript
const response = await fetch(`/api/payment/${orderId}/confirm`, { ... });
if (data.success) {
  navigate(`/success/${orderId}`);
}
```

### 5ï¸âƒ£ ç™»å½•é¡µ â†’ é¦–é¡µ
**è§¦å‘**ï¼šç”¨æˆ·æˆåŠŸç™»å½•
**è·¯å¾„**ï¼š`/login` â†’ `/`
**çŠ¶æ€ä¼ é€’**ï¼šlocalStorage (`userId`, `username`)
**æ–‡ä»¶**ï¼š`frontend/src/pages/LoginPage.tsx`

### 6ï¸âƒ£ æ³¨å†Œé¡µ â†’ ç™»å½•é¡µ
**è§¦å‘**ï¼šç”¨æˆ·å®Œæˆæ³¨å†Œ
**è·¯å¾„**ï¼š`/register` â†’ `/login`
**æ–‡ä»¶**ï¼š`frontend/src/pages/RegistrationPage.tsx`

---

## ğŸ”— API ç«¯ç‚¹æ˜ å°„

### è®¢å•ç›¸å…³
- `POST /api/orders/submit` â†’ æäº¤è®¢å•ï¼Œè¿”å› `{ success, orderId }`
- `GET /api/payment/:orderId` â†’ è·å–è®¢å•æ”¯ä»˜ä¿¡æ¯
- `POST /api/payment/:orderId/confirm` â†’ ç¡®è®¤æ”¯ä»˜
- `POST /api/payment/:orderId/cancel` â†’ å–æ¶ˆè®¢å•
- `GET /api/orders/:orderId/success` â†’ è·å–è´­ç¥¨æˆåŠŸä¿¡æ¯
- `GET /api/orders` â†’ è·å–ç”¨æˆ·è®¢å•åˆ—è¡¨ï¼ˆæ”¯æŒ30å¤©è¿‡æ»¤ï¼‰

### è®¤è¯ç›¸å…³
- `POST /api/auth/login` â†’ ç”¨æˆ·ç™»å½•
- `POST /api/auth/register` â†’ ç”¨æˆ·æ³¨å†Œ
- `POST /api/auth/send-verification-code` â†’ å‘é€éªŒè¯ç 
- `POST /api/auth/verify-code` â†’ éªŒè¯éªŒè¯ç 

### è½¦æ¬¡ç›¸å…³
- `POST /api/trains/search` â†’ æœç´¢è½¦æ¬¡
- `GET /api/trains/:trainNumber/details` â†’ è·å–è½¦æ¬¡è¯¦æƒ…
- `GET /api/trains/cities` â†’ è·å–åŸå¸‚åˆ—è¡¨

---

## âœ… è·³è½¬éªŒè¯æµ‹è¯•æ­¥éª¤

### æµ‹è¯• 1: å®Œæ•´è´­ç¥¨æµç¨‹
```
1. æ‰“å¼€é¦–é¡µ (/)
   âœ… é¡µé¢æ­£å¸¸æ˜¾ç¤º
   
2. å¡«å†™æœç´¢æ¡ä»¶å¹¶ç‚¹å‡»"æŸ¥è¯¢"
   âœ… è·³è½¬åˆ°è½¦æ¬¡åˆ—è¡¨é¡µ (/trains)
   âœ… æ˜¾ç¤ºæœç´¢ç»“æœ
   
3. ç‚¹å‡»æŸè½¦æ¬¡çš„"é¢„å®š"æŒ‰é’®
   âœ… è·³è½¬åˆ°è®¢å•å¡«å†™é¡µ (/order)
   âœ… æ˜¾ç¤ºè½¦æ¬¡ä¿¡æ¯
   
4. é€‰æ‹©ä¹˜å®¢å¹¶ç‚¹å‡»"æäº¤è®¢å•"
   âœ… å¼¹å‡ºè®¢å•ç¡®è®¤å¼¹çª—
   
5. ç‚¹å‡»"ç¡®è®¤æ— è¯¯ï¼Œæäº¤è®¢å•"
   âœ… è°ƒç”¨ POST /api/orders/submit
   âœ… åç«¯è¿”å› { success: true, orderId: "1" }
   âœ… è·³è½¬åˆ°æ”¯ä»˜é¡µé¢ (/payment/1)
   âœ… ä¸å†æ˜¾ç¤º SQL è¯­æ³•é”™è¯¯
   
6. ç‚¹å‡»"ç½‘ä¸Šæ”¯ä»˜"
   âœ… è°ƒç”¨ POST /api/payment/1/confirm
   âœ… è·³è½¬åˆ°è´­ç¥¨æˆåŠŸé¡µ (/success/1)
   âœ… æ˜¾ç¤ºè®¢å•è¯¦æƒ…
```

### æµ‹è¯• 2: ç™»å½•æµç¨‹
```
1. æ‰“å¼€ç™»å½•é¡µ (/login)
   âœ… é¡µé¢æ­£å¸¸æ˜¾ç¤º
   
2. è¾“å…¥ç”¨æˆ·åå’Œå¯†ç 
   âœ… éªŒè¯é€šè¿‡
   
3. ç‚¹å‡»"ç«‹å³ç™»å½•"
   âœ… è·³è½¬åˆ°é¦–é¡µ (/)
   âœ… localStorage ä¸­å­˜å‚¨ userId å’Œ username
   âœ… é¡¶éƒ¨å¯¼èˆªæ˜¾ç¤ºç”¨æˆ·å
```

### æµ‹è¯• 3: ä¸ªäººä¸­å¿ƒ
```
1. ç‚¹å‡»é¡¶éƒ¨å¯¼èˆªçš„"ä¸ªäººä¸­å¿ƒ"
   âœ… è·³è½¬åˆ°ä¸ªäººä¿¡æ¯é¡µ (/personal-info)
   
2. åˆ‡æ¢åˆ°"æˆ‘çš„è®¢å•" Tab
   âœ… æ˜¾ç¤ºç”¨æˆ·è®¢å•åˆ—è¡¨
   âœ… é»˜è®¤åªæ˜¾ç¤º30å¤©å†…çš„è®¢å•
   
3. ç‚¹å‡»æŸè®¢å•çš„"å»æ”¯ä»˜"æŒ‰é’®
   âœ… è·³è½¬åˆ°æ”¯ä»˜é¡µé¢ (/payment/:orderId)
```

---

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1: é¡µé¢è·³è½¬åæ˜¾ç¤ºç©ºç™½
**åŸå› **ï¼šè·¯ç”±é…ç½®é”™è¯¯æˆ–ç»„ä»¶æœªæ­£ç¡®å¯¼å…¥
**è§£å†³**ï¼šæ£€æŸ¥ `frontend/src/App.tsx` ä¸­çš„ Routes é…ç½®

### é—®é¢˜2: è·³è½¬åå‚æ•°ä¸¢å¤±
**åŸå› **ï¼šä½¿ç”¨ `navigate()` æ—¶æœªæ­£ç¡®ä¼ é€’ state æˆ– URL å‚æ•°
**è§£å†³**ï¼š
- URL å‚æ•°ï¼š`navigate(\`/payment/\${orderId}\`)`
- State å‚æ•°ï¼š`navigate('/trains', { state: { ... } })`

### é—®é¢˜3: API è¿”å› 404
**åŸå› **ï¼šåç«¯è·¯ç”±é…ç½®é”™è¯¯æˆ– API ç«¯ç‚¹ä¸å­˜åœ¨
**è§£å†³**ï¼šæ£€æŸ¥ `backend/src/routes/api.js` ä¸­çš„è·¯ç”±å®šä¹‰

### é—®é¢˜4: SQL è¯­æ³•é”™è¯¯
**åŸå› **ï¼šä½¿ç”¨äº† SQL ä¿ç•™å…³é”®å­—ä½œä¸ºè¡¨åˆ«åï¼ˆå¦‚ `as`, `select`, `from` ç­‰ï¼‰
**è§£å†³**ï¼šä½¿ç”¨éä¿ç•™å­—ä½œä¸ºåˆ«åï¼ˆå¦‚ `arr_s`, `dep_s` ç­‰ï¼‰

---

## ğŸ“Š åç«¯æ—¥å¿—ç›‘æ§

### æ­£å¸¸æµç¨‹æ—¥å¿—ç¤ºä¾‹
```
âœ… [ä¹˜å®¢åˆ—è¡¨] è¿”å› 1 æ¡è®°å½•
ğŸ“¤ [è®¢å•æäº¤] ç”¨æˆ· 1 æäº¤è®¢å•
âœ… [è®¢å•æäº¤] è®¢å•åˆ›å»ºæˆåŠŸ, orderId: 3
ğŸ’° [è·å–è®¢å•æ”¯ä»˜ä¿¡æ¯] orderId: 3
ğŸ“¦ [è·å–è®¢å•æ”¯ä»˜ä¿¡æ¯] æŸ¥è¯¢ç»“æœ: { orderId: 3, trainNumber: 'G103', ... }
âœ… [è·å–è®¢å•æ”¯ä»˜ä¿¡æ¯] è¿”å›è®¢å•ä¿¡æ¯
ğŸ’³ [æ”¯ä»˜ç¡®è®¤] ç¡®è®¤æ”¯ä»˜è®¢å•, orderId: 3
âœ… [æ”¯ä»˜ç¡®è®¤] æ”¯ä»˜æˆåŠŸ
ğŸ‰ [è·å–è´­ç¥¨æˆåŠŸä¿¡æ¯] orderId: 3
âœ… [è·å–è´­ç¥¨æˆåŠŸä¿¡æ¯] è¿”å›è®¢å•è¯¦æƒ…
```

### å¼‚å¸¸æµç¨‹æ—¥å¿—ç¤ºä¾‹
```
âŒ [è·å–è®¢å•æ”¯ä»˜ä¿¡æ¯å¤±è´¥]: [Error: SQLITE_ERROR: near "as": syntax error]
âŒ [è®¢å•æäº¤] è®¢å•åˆ›å»ºå¤±è´¥: è½¦æ¬¡ G999 ä¸å­˜åœ¨
âŒ [æ”¯ä»˜ç¡®è®¤] è®¢å• 999 ä¸å­˜åœ¨
```

---

## ğŸ” æƒé™éªŒè¯

### éœ€è¦ç™»å½•çš„é¡µé¢
- `/order` - è®¢å•å¡«å†™é¡µ
- `/payment/:orderId` - æ”¯ä»˜é¡µé¢
- `/personal-info` - ä¸ªäººä¿¡æ¯é¡µ
- `/passengers` - ä¹˜å®¢ç®¡ç†é¡µ
- `/orders` - è®¢å•å†å²é¡µ

**éªŒè¯æ–¹å¼**ï¼š
- æ£€æŸ¥ `localStorage.getItem('userId')`
- å¦‚æœæœªç™»å½•ï¼Œè·³è½¬åˆ° `/login`

---

**æœ€åæ›´æ–°**ï¼š2026-01-19
**ç‰ˆæœ¬**ï¼šv1.0
