# ğŸš€ 12306ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–è®°å½•

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–è®°å½•

### 2026-01-19ï¼šè½¦æ¬¡æœç´¢æ€§èƒ½ä¼˜åŒ–

#### **é—®é¢˜æè¿°**
ç”¨æˆ·åé¦ˆï¼š
- æŸ¥è¯¢åˆ°7ä¸ªè½¦æ¬¡åï¼Œè¦å¾ˆä¹…æ‰èƒ½åœ¨è½¦æ¬¡åˆ—è¡¨ä¸­æ˜¾ç¤º
- æ•´ä½“ç½‘é¡µé€Ÿåº¦æ…¢ï¼ŒæŒ‰é’®ç‚¹å‡»åè·³è½¬æ…¢

#### **æ ¹å› åˆ†æ**

**åç«¯æ€§èƒ½ç“¶é¢ˆ**ï¼ˆä¸»è¦é—®é¢˜ï¼‰ï¼š
```javascript
// âŒ Before: ä¸²è¡ŒæŸ¥è¯¢ï¼ˆè€—æ—¶ï¼‰
for (const train of trains) {  // 7ä¸ªè½¦æ¬¡
  const seats = await db.allAsync(`
    SELECT ... WHERE train_id = ?
  `, train.train_id);
  // æ¯æ¬¡æŸ¥è¯¢éƒ½è¦ç­‰å¾…
}

// æŸ¥è¯¢7ä¸ªè½¦æ¬¡éœ€è¦ï¼š
// 1æ¬¡æŸ¥è½¦æ¬¡ + 7æ¬¡æŸ¥åº§ä½ = 8æ¬¡æ•°æ®åº“æŸ¥è¯¢
// æ€»è€—æ—¶ â‰ˆ 8 Ã— å•æ¬¡æŸ¥è¯¢æ—¶é—´
```

**æ€§èƒ½æ•°æ®**ï¼š
- æŸ¥è¯¢7ä¸ªè½¦æ¬¡ï¼š~1-2ç§’
- æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°ï¼š8æ¬¡
- ä¸»è¦è€—æ—¶ï¼šä¸²è¡Œç­‰å¾…

---

#### **ä¼˜åŒ–æ–¹æ¡ˆ**

**1. æ‰¹é‡æŸ¥è¯¢åº§ä½ä¿¡æ¯**

```javascript
// âœ… After: æ‰¹é‡æŸ¥è¯¢ï¼ˆé«˜æ•ˆï¼‰
const trainIds = trains.map(t => t.train_id);
const allSeats = await db.allAsync(`
  SELECT ... WHERE train_id IN (?, ?, ?, ...)
`, ...trainIds);

// æŒ‰ train_id åˆ†ç»„
const seatsByTrainId = {};
allSeats.forEach(seat => {
  if (!seatsByTrainId[seat.train_id]) {
    seatsByTrainId[seat.train_id] = [];
  }
  seatsByTrainId[seat.train_id].push(seat);
});

// æŸ¥è¯¢7ä¸ªè½¦æ¬¡éœ€è¦ï¼š
// 1æ¬¡æŸ¥è½¦æ¬¡ + 1æ¬¡æŸ¥æ‰€æœ‰åº§ä½ = 2æ¬¡æ•°æ®åº“æŸ¥è¯¢
// æ€»è€—æ—¶ â‰ˆ 2 Ã— å•æ¬¡æŸ¥è¯¢æ—¶é—´
```

**ä¼˜åŒ–æ•ˆæœ**ï¼š
- æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°ï¼š**ä»8æ¬¡å‡å°‘åˆ°2æ¬¡**ï¼ˆå‡å°‘75%ï¼‰
- é¢„æœŸæ€§èƒ½æå‡ï¼š**70%ä»¥ä¸Š**
- æŸ¥è¯¢7ä¸ªè½¦æ¬¡ï¼šé¢„æœŸä»1-2ç§’å‡å°‘åˆ°**200-500ms**

---

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### **P0 - å·²å®Œæˆ**
- âœ… æ‰¹é‡æŸ¥è¯¢åº§ä½ä¿¡æ¯ï¼ˆæœ¬æ¬¡ä¼˜åŒ–ï¼‰

#### **P1 - å»ºè®®å®æ–½**

**1. æ·»åŠ æ•°æ®åº“ç´¢å¼•**
```sql
-- è½¦æ¬¡æŸ¥è¯¢ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_trains_city_active 
  ON trains(departure_station_id, arrival_station_id, is_active);

-- åº§ä½æŸ¥è¯¢ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_train_seats_train_id 
  ON train_seats(train_id);
```

**2. å‰ç«¯å“åº”å¼ä¼˜åŒ–**
```javascript
// ä½¿ç”¨ React.memo é¿å…ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“
const TrainListItem = React.memo(({ train }) => {
  // ...
});

// ä½¿ç”¨ useMemo ç¼“å­˜è®¡ç®—ç»“æœ
const sortedTrains = useMemo(() => {
  return trains.sort((a, b) => a.departureTime.localeCompare(b.departureTime));
}, [trains]);
```

**3. ç§»é™¤ç”Ÿäº§ç¯å¢ƒçš„ console.log**
```javascript
// åœ¨ vite.config.ts ä¸­é…ç½®
export default defineConfig({
  esbuild: {
    drop: process.env.NODE_ENV === 'production' ? ['console', 'debugger'] : []
  }
});
```

**4. å¯ç”¨HTTP/2**
- åç«¯æœåŠ¡å™¨å¯ç”¨HTTP/2ï¼ˆå¤šè·¯å¤ç”¨ï¼‰
- å‡å°‘ç½‘ç»œå¾€è¿”æ—¶é—´

---

#### **P2 - å¯é€‰ä¼˜åŒ–**

**1. Redisç¼“å­˜ä½™ç¥¨æ•°é‡**
```javascript
// ç¼“å­˜é”®ï¼štickets:{scheduleId}:{fromSeq}:{toSeq}:{seatType}
// ç¼“å­˜æ—¶é•¿ï¼š60ç§’
// å®šæ—¶åˆ·æ–°ï¼šæ¯åˆ†é’Ÿ
```

**2. å‰ç«¯æ•°æ®ç¼“å­˜**
```javascript
// ä½¿ç”¨ SWR æˆ– React Query ç¼“å­˜ API å“åº”
import useSWR from 'swr';

const { data, error } = useSWR(
  `/api/trains/search?from=${from}&to=${to}`,
  fetcher,
  { revalidateOnFocus: false }
);
```

**3. æ‡’åŠ è½½ç»„ä»¶**
```javascript
// ä»£ç åˆ†å‰²ï¼ŒæŒ‰éœ€åŠ è½½
const OrderPage = React.lazy(() => import('./pages/OrderPage'));
```

**4. è™šæ‹Ÿæ»šåŠ¨**
```javascript
// å¦‚æœè½¦æ¬¡åˆ—è¡¨å¾ˆé•¿ï¼ˆ>100ä¸ªï¼‰ï¼Œä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨
import { FixedSizeList } from 'react-window';
```

---

### æ€§èƒ½ç›‘æ§

#### **å…³é”®æŒ‡æ ‡**

| æŒ‡æ ‡ | Before | After | æ”¹å–„ |
|------|--------|-------|------|
| **æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°** | 8æ¬¡ | 2æ¬¡ | â†“75% |
| **æŸ¥è¯¢å“åº”æ—¶é—´** | 1-2ç§’ | 200-500ms | â†“70% |
| **é¦–å±åŠ è½½æ—¶é—´** | - | - | - |
| **é¡µé¢è·³è½¬æ—¶é—´** | - | - | - |

#### **ç›‘æ§æ–¹æ³•**

**1. åç«¯æ—¥å¿—**
```javascript
console.time('æœç´¢è½¦æ¬¡');
const trains = await searchTrains(...);
console.timeEnd('æœç´¢è½¦æ¬¡');  // æœç´¢è½¦æ¬¡: 250ms
```

**2. å‰ç«¯ Performance API**
```javascript
const startTime = performance.now();
const response = await fetch('/api/trains/search', ...);
const endTime = performance.now();
console.log(`APIè°ƒç”¨è€—æ—¶: ${endTime - startTime}ms`);
```

**3. Chrome DevTools**
- Network Tab - æŸ¥çœ‹è¯·æ±‚æ—¶é—´
- Performance Tab - å½•åˆ¶é¡µé¢æ€§èƒ½
- Lighthouse - ç»¼åˆæ€§èƒ½è¯„åˆ†

---

### æ€§èƒ½æµ‹è¯•æ¸…å•

#### **æµ‹è¯•åœºæ™¯1ï¼šè½¦æ¬¡æœç´¢**
```
è¾“å…¥ï¼šåŒ—äº¬ â†’ ä¸Šæµ·, 2026-01-20
é¢„æœŸï¼š
  - åç«¯æŸ¥è¯¢ < 500ms
  - ç½‘ç»œä¼ è¾“ < 100ms
  - å‰ç«¯æ¸²æŸ“ < 200ms
  - æ€»æ—¶é—´ < 800ms
```

#### **æµ‹è¯•åœºæ™¯2ï¼šå¤šæ¬¡æŸ¥è¯¢**
```
æ“ä½œï¼šè¿ç»­ä¿®æ”¹æ—¥æœŸ5æ¬¡
é¢„æœŸï¼šæ¯æ¬¡æŸ¥è¯¢éƒ½åº” < 800ms
```

#### **æµ‹è¯•åœºæ™¯3ï¼šå¤§é‡è½¦æ¬¡**
```
è¾“å…¥ï¼šæŸ¥è¯¢ç»“æœ > 20ä¸ªè½¦æ¬¡
é¢„æœŸï¼š
  - åç«¯æŸ¥è¯¢ < 1s
  - åˆ—è¡¨æ¸²æŸ“ < 500ms
```

---

### å·²çŸ¥é—®é¢˜

#### **é—®é¢˜1ï¼šæ•´ä½“é¡µé¢å“åº”æ…¢**
**çŠ¶æ€**ï¼šéƒ¨åˆ†ä¼˜åŒ–

**å‰©ä½™å·¥ä½œ**ï¼š
1. æ£€æŸ¥å‰ç«¯æ˜¯å¦æœ‰ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“
2. æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤çš„APIè°ƒç”¨
3. ä¼˜åŒ–è·¯ç”±è·³è½¬é€»è¾‘

**å»ºè®®**ï¼š
- ä½¿ç”¨ React DevTools Profiler åˆ†ææ¸²æŸ“æ€§èƒ½
- æ£€æŸ¥ useEffect ä¾èµ–æ•°ç»„æ˜¯å¦æ­£ç¡®
- é¿å…åœ¨ render ä¸­åˆ›å»ºæ–°å¯¹è±¡/å‡½æ•°

---

### æ€§èƒ½ä¼˜åŒ–Checklist

#### **åç«¯ä¼˜åŒ–**
- [x] æ‰¹é‡æŸ¥è¯¢åº§ä½ä¿¡æ¯
- [ ] æ·»åŠ æ•°æ®åº“ç´¢å¼•
- [ ] ä½¿ç”¨è¿æ¥æ± 
- [ ] å¯ç”¨æŸ¥è¯¢ç¼“å­˜
- [ ] å‹ç¼©å“åº”æ•°æ®ï¼ˆgzipï¼‰

#### **å‰ç«¯ä¼˜åŒ–**
- [ ] ç§»é™¤ç”Ÿäº§ç¯å¢ƒ console.log
- [ ] ä½¿ç”¨ React.memo ä¼˜åŒ–ç»„ä»¶
- [ ] ä½¿ç”¨ useMemo/useCallback ç¼“å­˜è®¡ç®—
- [ ] ä»£ç åˆ†å‰²ï¼ˆReact.lazyï¼‰
- [ ] å›¾ç‰‡æ‡’åŠ è½½
- [ ] å¯ç”¨æµè§ˆå™¨ç¼“å­˜

#### **ç½‘ç»œä¼˜åŒ–**
- [ ] å¯ç”¨HTTP/2
- [ ] ä½¿ç”¨CDN
- [ ] å‹ç¼©é™æ€èµ„æº
- [ ] å‡å°‘è¯·æ±‚æ•°é‡ï¼ˆåˆå¹¶èµ„æºï¼‰

---

**æœ€åæ›´æ–°**ï¼š2026-01-19
**ä¼˜åŒ–ç‰ˆæœ¬**ï¼šcommit fef4657
