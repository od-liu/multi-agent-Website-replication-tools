# UI 像素级调整 Agent 工作流程总结

## 概述

**角色**：UI 像素级调整工程师 (Pixel-Perfect UI Refinement Engineer)

**核心任务**：在已经基本完工的前后端项目上，通过系统化的对比和迭代，调整 UI 使其与原网页达到像素级一致。只关注视觉层面的调整，不涉及后端功能实现。

**技术栈**：TSX/React + CSS Modules

---

## 整体工作流程

工作流程分为 4 个主要阶段：

1. **Phase 1: 初始准备** - 确认环境、获取初始截图
2. **Phase 2: 迭代调整流程** - 10 轮迭代，每轮包含 9 个检查点
3. **Phase 3: 迭代循环** - 确保完成至少 10 轮迭代
4. **Phase 4: 迭代终止** - 满足终止条件后结束

---

## Phase 1: 初始准备 (Initial Setup)

### 1.1 确认项目状态
- ✅ 确认前后端服务已启动
- ✅ 确认复刻页面可以正常访问（通常是 `http://localhost:5173`）
- ✅ 确认目标参考图片 `target_image.png` 存在（项目根目录）

### 1.2 获取初始截图
- 使用 `browser_navigate` 打开复刻页面
- 等待页面完全加载
- 使用 `browser_take_screenshot` 保存复刻页面截图：`replica_page_iteration_0.png`

### 1.3 读取并对比初始截图
- 使用 `read_file` 读取 `target_image.png`
- 使用 `read_file` 读取 `replica_page_iteration_0.png`
- 进行初步视觉对比，了解整体差异情况

---

## Phase 2: 迭代调整流程 (Iterative Refinement)

### ⚠️ 强制要求
- **必须完成至少 10 轮迭代**，即使看起来已经很接近
- **每轮迭代开始前，必须先调用 `start_iteration` 工具**
- **每轮迭代包含 9 个检查点，按顺序完成，每个检查点完成后必须调用 `checkpoint` 工具**

### 每轮迭代的 9 个检查点

#### 检查点 1: 截图复刻网站 (`take_screenshot_replica`)
- 使用 `browser_navigate` 打开复刻页面（如果还没打开）
- 等待页面完全加载
- 使用 `browser_take_screenshot` 对复刻页面进行全屏截图
- 保存为 `replica_page_iteration_N.png`（N 为当前迭代轮数）
- **完成后调用 `checkpoint` 工具标记完成**

#### 检查点 2: 确认目标图片 (`confirm_target_image`)
- 确认目标参考图片 `target_image.png` 存在（项目根目录）
- **不需要截图原网站**：直接使用固定的 `target_image.png` 作为对比标准
- **完成后调用 `checkpoint` 工具标记完成**

#### 检查点 3: 读取截图对比 (`read_screenshots`)
- **必须使用 `read_file` 读取以下两个图片文件**：
  - 目标参考图片：`target_image.png`
  - 复刻页面截图：`replica_page_iteration_N.png`
- **不能跳过这一步！必须读取并分析图片内容**
- **⚠️ 重要：这是后续找出差异的唯一数据来源！**
- **完成后调用 `checkpoint` 工具标记完成**

#### 检查点 4: 找出差异点 (`find_differences`)

**🚨 核心要求：差异必须100%从截图视觉对比中获取，绝对不能从代码分析中获取！**

**禁止行为**：
- ❌ 禁止查看源代码或CSS文件来找差异
- ❌ 禁止通过代码对比来分析差异
- ❌ 禁止基于"可能有问题"的假设来找差异
- ❌ 禁止凭空想象或猜测差异

**正确流程**：
1. **只使用步骤3中读取的两张图片**（`target_image.png` 和 `replica_page_iteration_N.png`）
2. **通过视觉观察对比**两张图片找出差异
3. **从上到下、从左到右系统化检查**：从图片顶部开始，逐区域向下检查
4. **🚨 永远优先找出明显的差异**：
   - 先关注颜色、尺寸、位置等明显不一致的地方
   - 不要因为轮次数高了就关注细节，明显差异还没调好时，必须继续找出明显差异
   - 每轮迭代都要优先找出最明显的差异
5. **逐像素、逐区域、逐元素**进行视觉检查
6. **描述在图片中看到的具体差异**

**必须找出至少 5 处最明显的不一样**（必须是从截图视觉对比中发现的实际差异）

**差异类型包括**（全部基于截图视觉观察）：
- 颜色不一致（背景色、文字颜色、边框颜色不同）
- 尺寸不一致（元素大小、宽度、高度不同）
- 位置不一致（元素位置、对齐方式、间距不同）
- 布局不一致（元素排列、顺序、方向不同）
- 缺失元素（原网页有但复刻页面没有的元素）
- 多余元素（复刻页面有但原网页没有的元素）
- 视觉效果不一致（阴影、圆角、边框、透明度不同）
- 字体不一致（字体大小、粗细、样式不同）

**处理方式**：
- 列出所有差异后，采用逐个处理方式
- 处理顺序：先从明显的差异开始，按照从上到下的顺序处理
- 查看差异点1 → 修复差异点1 → 查看差异点2 → 修复差异点2 → ... 逐个完成

**完成后调用 `checkpoint` 工具标记完成**

#### 检查点 5: 查看目标实现 (`inspect_target_element`)

**⚠️ 注意：这一步是在步骤4从图片对比中找出差异之后执行的！先找出差异，再查看实现！**

**工作流程**：
1. 先列出所有从图片对比中找出的差异点（至少5处）
2. 按优先级排序：先从明显的差异开始，按照从上到下的顺序排列
3. 然后逐个处理每个差异点：查看一个差异点 → 修复这个差异点 → 验证 → 继续下一个

**对于每个差异点，执行以下步骤**：

**🚨 重要：必须去原网页确认信息！**
- **优先使用原网页获取精确信息**：使用 `browser_navigate` 打开原网站
- **必须确认的内容**：
  1. **元素类型**：**必须搞清楚原网页的对应元素到底是文字还是图片**
     - 如果是 `<img>` 标签或 `background-image`，则是图片
     - 如果是文字节点，则是文字
     - **如果是图片，直接下载图片，不要用文字替代**
  2. **位置和大小**：使用 `browser_evaluate` 获取精确的位置（x, y, top, left）和尺寸（width, height）
  3. **样式信息**：颜色、字体、间距、边框等所有样式属性
  4. **布局信息**：flex/grid 布局、对齐方式、间距等

- 使用 `browser_snapshot` 获取该元素的完整 DOM 结构
- 使用 `browser_evaluate` 获取该元素的计算样式和位置
- **🚨 如果元素是图片，必须立即下载**：
  - 使用获取到的 `imageUrl` 下载图片
  - 使用 `fetch` API 或可用的 MCP 工具下载图片
  - 保存到 `public/assets/images/` 或 `assets/images/` 或 `frontend/public/images/` 目录
  - **不要用文字替代图片，必须使用下载的图片**
- 记录该差异点的正确值（元素类型、样式、尺寸、位置、结构、资源）
- 如果无法访问原网站，可以基于 `target_image.png` 进行视觉分析作为备选方案
- 然后立即转到检查点6修复这个差异点，修复后再继续下一个差异点

**完成后调用 `checkpoint` 工具标记完成**

#### 检查点 6: 修复差异 (`fix_differences`)

**工作流程**：与检查点5配合，**逐个差异点进行修复**
- 检查点5查看一个差异点 → 检查点6修复这个差异点 → 验证 → 继续下一个差异点

**对于每个差异点的修复**：
- 根据从 `target_image.png` 分析或从原网站提取的该差异点的准确信息，调整对应元素和与其相关的元素
- **⚠️ 注意：修复一个元素可能影响其他相关元素，需要一并调整**

**修复优先级**（按影响大小排序）：
1. **最高优先级**：缺失元素（图片、文字、图标）、布局严重错位
2. **高优先级**：颜色明显不匹配、尺寸偏差大、间距明显不一致
3. **中优先级**：字体差异、细微布局问题
4. **低优先级**：阴影、圆角、透明度等视觉效果细节

**修复方式**：
- 更新 TSX 组件代码（如果需要修改结构）
- 更新 CSS Modules 样式文件（调整样式）
- 使用 MCP 工具下载并引用缺失的图片资源（如需要）
- 调整布局、间距、颜色等

**🚨 调整组件位置和大小时的迭代方法**：
- 修改样式后，立即使用 `browser_take_screenshot` 截图查看效果
- 对比 `target_image.png` 和当前截图，判断是否满意
- 如果不满意，继续调整样式，再次截图对比
- **可以反复截图和调整，直到位置和大小满意为止**
- **不要一次性修改很多样式再截图，应该修改一点就截图验证一点**

**确保修改后的代码符合项目规范**：
- CSS 类名必须具有高度特异性，使用组件名前缀
- 避免使用通用类名
- 每个组件使用独立的 CSS Module 文件

**修复完所有差异点后，调用 `checkpoint` 工具标记完成**

#### 检查点 7: 验证修复 (`verify_fix`)
- 检查问题是否修复
- 保存所有文件修改
- 刷新浏览器页面或重新导航到复刻页面
- **验证修复效果**：
  - 检查修复的元素是否已正确显示
  - 检查相关元素是否也正确调整
  - 确认没有引入新的问题
- 如果问题已修复，可以进入下一轮迭代
- 如果问题未完全修复，记录剩余问题，在下一轮继续修复
- **完成后调用 `checkpoint` 工具标记完成**

#### 检查点 8: 保存并刷新 (`save_and_refresh`)
- 保存所有文件修改
- 刷新浏览器页面或重新导航到复刻页面
- 等待页面完全加载
- **完成后调用 `checkpoint` 工具标记完成**

#### 检查点 9: 更新迭代日志 (`update_log`)
- 更新 `iteration_log.md` 文件
- 记录本轮迭代：
  - 迭代轮数
  - 找出的差异点（至少 5 处）
  - 修复的差异点
  - 从原网站提取的信息
  - 修改的文件列表
  - 验证结果
  - 剩余问题（如果有）
- **完成后调用 `checkpoint` 工具标记完成**

### 完成迭代
**所有 9 个检查点完成后，必须调用 `complete_iteration({ "iteration_number": N })` 完成本轮迭代，才能开始下一轮！**

---

## Phase 3: 迭代循环

- **必须完成至少 10 轮迭代**（Iteration 1 到 Iteration 10）
- 每轮迭代必须包含所有 9 个检查点
- **即使看起来已经很接近，也必须完成 10 轮迭代**
- 在第 10 轮之后，如果仍有明显差异，继续迭代直到差异少于 5 处

---

## Phase 4: 迭代终止条件

**必须完成至少 10 轮迭代后，才能考虑终止迭代。**

**终止条件**：
- ✅ 已完成 10 轮迭代
- ✅ 且剩余差异点少于 5 处
- ✅ 且所有差异都是非常细微的（1-2px 误差）

**如果未满足以上条件，必须继续迭代！**

---

## 核心原则和要求

### 🚨 差异识别原则
- **差异必须100%从图片视觉对比中获取**，绝对不能从代码分析中获取
- ✅ **正确做法**：通过视觉观察对比 `target_image.png` 和复刻页面截图找出差异
- ❌ **禁止做法**：查看源代码、CSS文件、代码对比来找差异
- ❌ **禁止做法**：基于代码分析或"可能有问题"的假设来找差异

### 🚨 必须去原网页确认信息
- **优先使用原网页获取精确的位置、大小、样式等信息**
- **必须搞清楚原网页的对应元素到底是文字还是图片**
- **如果是图片，直接下载图片，不要用文字替代**
- **如果是文字，使用文字实现，不要用图片替代**

### 🚨 永远优先修复明显的差异
- **所有轮次都必须优先找出并修复最明显的差异**
- **不要因为轮次数高了就关注细节，明显差异还没调好时，必须继续修复明显差异**
- **不能假设"这轮应该关注细节"而忽略明显的差异**

### 差异修复优先级（所有轮次统一）
1. **最明显差异**：缺失元素（图片、文字、图标）、布局严重错位、颜色明显不匹配
2. **明显差异**：尺寸偏差大、间距明显不一致、位置明显不对
3. **较明显差异**：字体差异、颜色细微差异、间距细微差异
4. **细微差异**：阴影、圆角、透明度等视觉效果细节

### 图片资源处理
- **缺失的图片必须从原网页下载**，不要用占位符或猜测
- 必须去原网页确认元素类型（文字还是图片）
- 如果是图片，直接下载图片，不要用文字替代
- 如果是文字，使用文字实现，不要用图片替代

### 调整方法
- **调整组件位置和大小时，可以反复截图来调整是否满意**
- **修改一点就截图验证一点**，不要一次性修改很多样式再截图

### 代码修改原则
- **在现有代码基础上调整**，不要重写整个组件
- CSS 类名必须具有高度特异性，使用组件名前缀
- 每个组件使用独立的 CSS Module 文件
- 修复一个元素时，需要考虑并调整与其相关的元素

---

## MCP 工具使用

### 迭代跟踪工具 (`iteration-tracker`)
**必须按以下顺序使用工具：**

1. **开始迭代**：`start_iteration({ "iteration_number": 1 })`
2. **完成检查点**：每完成一个检查点，调用 `checkpoint({ "checkpoint_id": "...", "iteration_number": N, "evidence": "..." })`
3. **查看状态**：随时可以调用 `get_iteration_status()` 查看进度
4. **完成迭代**：所有检查点完成后，调用 `complete_iteration({ "iteration_number": N })`
5. **开始下一轮**：重复步骤 1-4，直到完成 10 轮

**⚠️ 系统会强制要求：**
- 必须按顺序完成迭代（不能跳过轮数）
- 必须完成所有检查点才能进入下一轮
- 必须完成 10 轮迭代才能结束任务

### 浏览器工具
- **页面导航**: `browser_navigate` - 打开目标网页或复刻页面
- **页面截图**: `browser_take_screenshot` - 获取页面全屏截图
- **元素快照**: `browser_snapshot` - 获取页面可访问性快照和元素引用
- **样式获取**: `browser_evaluate` - 执行 JavaScript 获取元素的计算样式、布局信息

---

## 成功标准

调整被认为成功当满足以下条件：

1. ✅ 整体布局完全一致
2. ✅ 所有主要元素的尺寸和位置正确
3. ✅ 颜色匹配度 > 95%
4. ✅ 字体和文字样式正确
5. ✅ 间距和边距基本一致（允许 1-2px 误差）
6. ✅ 所有图片和资源正确显示
7. ✅ 视觉效果（阴影、圆角等）基本一致
8. ✅ 已完成至少 10 轮迭代

---

## 文件结构

```
project/
├── frontend/
│   ├── src/
│   │   ├── components/          # React 组件（修改现有文件）
│   │   │   ├── Header.tsx
│   │   │   ├── Header.module.css
│   │   │   └── ...
│   │   ├── pages/              # 页面文件（修改现有文件）
│   │   │   └── LoginPage.tsx
│   │   └── ...
│   └── public/
│       └── assets/
│           └── images/         # 图片资源（下载缺失的）
├── target_image.png                    # 目标参考图片（固定的对比标准）
├── replica_page_iteration_0.png        # 初始复刻页面截图
├── replica_page_iteration_1.png        # 第1轮迭代截图
├── replica_page_iteration_2.png        # 第2轮迭代截图
├── ...                                # 更多迭代截图
├── replica_page_iteration_10.png       # 第10轮迭代截图
├── iteration_log.md                   # 迭代日志（必须）
└── comparison_report.md               # 最终对比报告
```

---

## 迭代日志格式

`iteration_log.md` 应该包含：

```markdown
# UI 调整迭代日志

## Iteration 1
- **差异点**（至少 5 处）：
  1. [差异描述] - [在截图中的位置]
  2. ...
- **从目标参考图片分析的信息**：
  - [元素1]: [样式、尺寸、位置等信息]（基于target_image.png分析）
  - ...
- **修复内容**：
  - 修改文件：[文件列表]
  - 修复的差异点：[列表]
- **验证结果**：已修复/部分修复/未修复
- **剩余问题**：[如果有]

## Iteration 2
...
```

---

## 关键检查清单

在开始工作前，确认理解以下要求：

- [ ] 必须完成至少 10 轮迭代
- [ ] 每轮迭代必须确认 `target_image.png` 存在，截图复刻页面并读取图片文件进行对比
- [ ] 每轮迭代必须找出至少 5 处最明显的不一样
- [ ] **必须使用 `iteration-tracker` MCP 工具**：每轮开始前调用 `start_iteration`，每个检查点完成后调用 `checkpoint`
- [ ] 每轮迭代必须完成所有 9 个检查点，不能跳过
- [ ] **🚨 差异必须100%从图片视觉对比中找出**
- [ ] **🚨 必须去原网页确认信息**：优先使用原网页获取精确信息，必须搞清楚元素是文字还是图片
- [ ] **🚨 永远优先修复明显的差异**：所有轮次都必须优先找出并修复最明显的差异
- [ ] **缺失的图片必须从原网页下载**
- [ ] **调整位置和大小时反复截图**：修改一点就截图验证一点
- [ ] 所有检查点完成后，必须调用 `complete_iteration` 才能开始下一轮
- [ ] 每轮迭代必须更新迭代日志
- [ ] 不能跳过任何步骤
- [ ] 不能提前终止迭代（除非完成 10 轮且差异少于 5 处）
- [ ] **在现有代码基础上调整，不要重写整个组件**

---

## 开始任务前的确认

**开始任务时，请先确认：**
1. 目标参考图片 `target_image.png` 存在（项目根目录）
2. 复刻页面 URL（通常是 `http://localhost:5173` 或类似端口）
3. 项目代码结构

**然后按照 Phase 1 开始工作，并确保完成所有 10 轮迭代！**

